name: Create New Release

on:
  # v1.0, v1.1, v1.2 ‡¶è‡¶á ‡¶ß‡¶∞‡¶®‡ßá‡¶∞ ‡¶ü‡ßç‡¶Ø‡¶æ‡¶ó ‡¶™‡ßÅ‡¶∂ ‡¶ï‡¶∞‡¶≤‡ßá‡¶á ‡¶è‡¶á Workflow ‡¶ö‡¶≤‡¶¨‡ßá
  push:
    tags:
      - 'v*.*'

jobs:
  build-and-release:
    runs-on: ubuntu-latest

    # ‡¶∞‡¶ø‡¶≤‡¶ø‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶ú‡¶®‡ßç‡¶Ø ‡¶™‡ßç‡¶∞‡ßü‡ßã‡¶ú‡¶®‡ßÄ‡ßü 'write' ‡¶™‡¶æ‡¶∞‡¶Æ‡¶ø‡¶∂‡¶®
    permissions:
      contents: write

    steps:
      # ‡¶ß‡¶æ‡¶™ ‡ßß: ‡¶∞‡¶ø‡¶™‡ßã‡¶ú‡¶ø‡¶ü‡¶∞‡¶ø‡¶∞ ‡¶ï‡ßã‡¶° ‡¶Ü‡¶®‡¶æ
      - name: Checkout repository
        uses: actions/checkout@v4

      # ‡¶ß‡¶æ‡¶™ ‡ß®: JDK 17 ‡¶∏‡ßá‡¶ü‡¶Ü‡¶™ ‡¶ï‡¶∞‡¶æ
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      # ‡¶ß‡¶æ‡¶™ ‡ß©: GitHub Secrets ‡¶•‡ßá‡¶ï‡ßá Keystore ‡¶°‡¶ø‡¶ï‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
      - name: Decode Keystore
        run: |
          echo "${{ secrets.RELEASE_KEYSTORE }}" | base64 --decode > ${{ github.workspace }}/release.keystore
          
        # --- ‡¶®‡¶§‡ßÅ‡¶® ‡¶ß‡¶æ‡¶™: google-services.json ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ---
      - name: Create google-services.json
        env:
          GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON }}
        run: |
          echo $GOOGLE_SERVICES_JSON | base64 -d > app/google-services.json

      # ‡¶ß‡¶æ‡¶™ ‡ß™: gradlew ‡¶´‡¶æ‡¶á‡¶≤‡¶ï‡ßá ‡¶è‡¶ï‡ßç‡¶∏‡¶ø‡¶ï‡¶ø‡¶â‡¶ü ‡¶ï‡¶∞‡¶æ‡¶∞ ‡¶Ö‡¶®‡ßÅ‡¶Æ‡¶§‡¶ø ‡¶¶‡ßá‡¶ì‡ßü‡¶æ
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # ‡¶ß‡¶æ‡¶™ ‡ß´: ‡¶∏‡¶æ‡¶á‡¶® ‡¶ï‡¶∞‡¶æ ‡¶∞‡¶ø‡¶≤‡¶ø‡¶ú APK ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ
      - name: Build Signed Release APK
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          RELEASE_KEYSTORE_FILE: ${{ github.workspace }}/release.keystore
          RELEASE_KEYSTORE_PASSWORD: ${{ secrets.RELEASE_KEYSTORE_PASSWORD }}
          RELEASE_KEY_ALIAS: ${{ secrets.RELEASE_KEY_ALIAS }}
          RELEASE_KEY_PASSWORD: ${{ secrets.RELEASE_KEY_PASSWORD }}
        run: |
          # ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü ‡¶™‡ßç‡¶∞‡¶™‡¶æ‡¶∞‡ßç‡¶ü‡¶ø ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá‡¶ì ‡¶§‡¶•‡ßç‡¶Ø ‡¶™‡¶æ‡¶∏ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá (‡¶¨‡ßÅ‡¶≤‡ßá‡¶ü‡¶™‡ßç‡¶∞‡ßÅ‡¶´ ‡¶∏‡¶Æ‡¶æ‡¶ß‡¶æ‡¶®)
          ./gradlew assembleRelease \
            -PRELEASE_KEYSTORE_FILE=${{ env.RELEASE_KEYSTORE_FILE }} \
            -PRELEASE_KEYSTORE_PASSWORD=${{ env.RELEASE_KEYSTORE_PASSWORD }} \
            -PRELEASE_KEY_ALIAS=${{ env.RELEASE_KEY_ALIAS }} \
            -PRELEASE_KEY_PASSWORD=${{ env.RELEASE_KEY_PASSWORD }}

      # ‡¶ß‡¶æ‡¶™ ‡ß¨ (‡¶°‡¶ø‡¶¨‡¶æ‡¶ó‡¶ø‡¶Ç): APK ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø ‡¶ï‡ßã‡¶•‡¶æ‡ßü ‡¶§‡ßà‡¶∞‡¶ø ‡¶π‡ßü‡ßá‡¶õ‡ßá ‡¶§‡¶æ ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü ‡¶ï‡¶∞‡¶æ
      - name: List Release Directory Files for Debugging
        run: ls -R app/build/outputs/apk/release

      # ‡¶ß‡¶æ‡¶™ ‡ß≠: ‡¶∞‡¶ø‡¶≤‡¶ø‡¶ú APK ‡¶´‡¶æ‡¶á‡¶≤‡¶ü‡¶ø‡¶ï‡ßá Artifact ‡¶π‡¶ø‡¶∏‡ßá‡¶¨‡ßá ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
      - name: Upload Release APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: StreamX-Ultra-Release-APK
          path: app/build/outputs/apk/release/*.apk

      # ‡¶ß‡¶æ‡¶™ ‡ßÆ: ‡¶∞‡¶ø‡¶≤‡¶ø‡¶ú ‡¶®‡ßã‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶è‡¶¨‡¶Ç ‡¶∏‡¶Ç‡¶∏‡ßç‡¶ï‡¶∞‡¶£ ‡¶§‡¶•‡ßç‡¶Ø ‡¶∏‡¶Ç‡¶ó‡ßç‡¶∞‡¶π ‡¶ï‡¶∞‡¶æ (Updated for v1.2)
      - name: Create Release Notes and Get Version Info
        id: create_notes
        run: |
          VERSION_NAME=$(grep 'versionName' app/build.gradle.kts | sed -n 's/.*versionName = "\(.*\)".*/\1/p')
          
          # ‡¶®‡¶§‡ßÅ‡¶® ‡¶∞‡¶ø‡¶≤‡¶ø‡¶ú ‡¶®‡ßã‡¶ü ‡¶§‡ßà‡¶∞‡¶ø ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá (v1.2)
          echo "üöÄ StreamX Ultra v1.2 ‚Äì Visual Intelligence & Player Mastery" > RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "The most significant UI/UX update yet. Redefined Home Screen & Cinema-Grade Player Experience." >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "üé® Aesthetic & Functional Home UI" >> RELEASE_NOTES.md
          echo "---------------------------------" >> RELEASE_NOTES.md
          echo "üîπ **Futuristic Glassmorphism Design:** All channel cards now feature a modern glass-effect with dynamic shadows." >> RELEASE_NOTES.md
          echo "üîπ **Auto-Sliding Featured Banner:** Top banner now slides automatically and supports direct one-tap play." >> RELEASE_NOTES.md
          echo "üîπ **Pull-to-Refresh:** Swipe down on the home screen to instantly reload channel lists." >> RELEASE_NOTES.md
          echo "üîπ **Smart Connectivity Handling:** New 'No Internet' popup with retry mechanism for seamless error handling." >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "üé• Next-Gen Player Controls" >> RELEASE_NOTES.md
          echo "---------------------------------" >> RELEASE_NOTES.md
          echo "‚ú® **Pinch-to-Zoom (YouTube Style):** Pinch out to fill the screen, pinch in to fit original aspect ratio." >> RELEASE_NOTES.md
          echo "‚ú® **Advanced Aspect Ratio Control:** Manual toggle button for Fit, Fill, and Zoom modes." >> RELEASE_NOTES.md
          echo "‚ú® **Smart Live Stream UI:** Replaces seekbar with a 'LIVE' badge for real-time broadcasts." >> RELEASE_NOTES.md
          echo "‚ú® **Enhanced Gestures:** Smoother Volume & Brightness controls with visual feedback." >> RELEASE_NOTES.md
          echo "‚ú® **Precision Seeking:** Double-tap to skip 10s with new animated indicators." >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "üîç Search & Performance" >> RELEASE_NOTES.md
          echo "---------------------------------" >> RELEASE_NOTES.md
          echo "üî∏ **Instant Play from Search:** Click any channel in search results to play immediately." >> RELEASE_NOTES.md
          echo "üî∏ **Optimized Search Bar:** Improved responsiveness and close functionality." >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "üì¶ Version Information" >> RELEASE_NOTES.md
          echo "- Version Name: v1.2" >> RELEASE_NOTES.md
          echo "- Release Type: Major Feature Update" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "üì≤ Download APK" >> RELEASE_NOTES.md
          echo "https://github.com/cybernahid-dev/StreamX-Ultra/releases/download/v1.2/app-release.apk" >> RELEASE_NOTES.md
          echo "" >> RELEASE_NOTES.md

          echo "¬© AeonCoreX‚Ñ¢ ‚Äì All Rights Reserved" >> RELEASE_NOTES.md
          
          # ‡¶Ü‡¶â‡¶ü‡¶™‡ßÅ‡¶ü ‡¶∏‡ßá‡¶ü ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡¶§‡ßá ‡¶™‡¶∞‡ßá‡¶∞ ‡¶ß‡¶æ‡¶™‡ßá ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶Ø‡¶æ‡ßü
          echo "version_name=${VERSION_NAME}" >> $GITHUB_OUTPUT
          echo "notes_path=RELEASE_NOTES.md" >> $GITHUB_OUTPUT

      # ‡¶ß‡¶æ‡¶™ ‡ßØ: GitHub ‡¶∞‡¶ø‡¶≤‡¶ø‡¶ú ‡¶§‡ßà‡¶∞‡¶ø ‡¶è‡¶¨‡¶Ç APK ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶æ
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          # ‡¶ì‡ßü‡¶æ‡¶á‡¶≤‡ßç‡¶°‡¶ï‡¶æ‡¶∞‡ßç‡¶° ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßá APK ‡¶´‡¶æ‡¶á‡¶≤ ‡¶ñ‡ßÅ‡¶Å‡¶ú‡ßá ‡¶¨‡ßá‡¶∞ ‡¶ï‡¶∞‡¶æ ‡¶π‡¶ö‡ßç‡¶õ‡ßá
          files: app/build/outputs/apk/release/*.apk
          name: "Version ${{ steps.create_notes.outputs.version_name }}"
          tag_name: ${{ github.ref_name }}
          body_path: ${{ steps.create_notes.outputs.notes_path }}